// Import necessary packages
import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:google_sign_in/google_sign_in.dart';
// --- NEW IMPORT ---
// This allows us to check if we are on web, android, etc.
import 'package:flutter/foundation.dart' show kIsWeb;
// --- NEW IMPORT ---
// This allows us to format the OTP text field
import 'package:flutter/services.dart';

// This file is generated by `flutterfire configure`
// If you have an error here, run `flutterfire configure`
import 'firebase_options.dart';

// --- Main Function: Initializes Firebase ---
Future<void> main() async {
  // Ensure Flutter widgets are initialized
  WidgetsFlutterBinding.ensureInitialized();

  // Initialize Firebase using the generated `firebase_options.dart`
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );

  runApp(const AuthApp());
}

class AuthApp extends StatelessWidget {
  const AuthApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Flutter Firebase Auth',
      theme: ThemeData(
        primarySwatch: Colors.blue,
        fontFamily: 'Inter',
        // Simple theme for a clean look
        colorScheme: ColorScheme.fromSeed(seedColor: Colors.blue),
        useMaterial3: true,
        inputDecorationTheme: InputDecorationTheme(
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12.0),
          ),
          filled: true,
          fillColor: Colors.grey[100],
        ),
        elevatedButtonTheme: ElevatedButtonThemeData(
          style: ElevatedButton.styleFrom(
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(12.0),
            ),
            padding: const EdgeInsets.symmetric(vertical: 16.0),
          ),
        ),
      ),
      debugShowCheckedModeBanner: false,
      home: const AuthWrapper(), // Start at the Auth Wrapper
    );
  }
}

// --- AuthWrapper: The Core Logic ---
// This widget listens to Firebase auth state changes.
// If the user is logged in, it shows HomeScreen.
// If the user is logged out, it shows AuthScreen (Login/Signup toggle).
class AuthWrapper extends StatelessWidget {
  const AuthWrapper({super.key});

  @override
  Widget build(BuildContext context) {
    return StreamBuilder<User?>(
      // Listen to the authentication state stream
      stream: FirebaseAuth.instance.authStateChanges(),
      builder: (context, snapshot) {
        // Show a loading spinner while connecting
        if (snapshot.connectionState == ConnectionState.waiting) {
          return const Scaffold(
            body: Center(child: CircularProgressIndicator()),
          );
        }

        // If a user is logged in (snapshot has data)
        if (snapshot.hasData) {
          return const HomeScreen(); // Go to the protected Home Screen
        }

        // If no user is logged in
        return const AuthScreen(); // Go to the Login/Sign Up page
      },
    );
  }
}

// --- AuthScreen: Toggles between Login and Sign Up ---
class AuthScreen extends StatefulWidget {
  const AuthScreen({super.key});

  @override
  State<AuthScreen> createState() => _AuthScreenState();
}

class _AuthScreenState extends State<AuthScreen> {
  // bool to toggle between Login and Sign Up
  bool _showLogin = true;

  void toggleView() {
    setState(() {
      _showLogin = !_showLogin;
    });
  }

  @override
  Widget build(BuildContext context) {
    if (_showLogin) {
      return LoginScreen(onToggleView: toggleView);
    } else {
      return SignUpScreen(onToggleView: toggleView);
    }
  }
}

// --- LoginScreen: Handles User Sign In ---
class LoginScreen extends StatefulWidget {
  final VoidCallback onToggleView;
  // --- THIS LINE IS NOW CORRECTED ---
  const LoginScreen({super.key, required this.onToggleView});

  @override
  State<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  final _formKey = GlobalKey<FormState>();
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  bool _loading = false;

  // Function to show a snackbar with an error message
  void _showError(String message) {
    // Remove "Exception: " from the start of the message if present
    final displayMessage = message.startsWith("Exception: ")
        ? message.substring("Exception: ".length)
        : message;

    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(displayMessage),
        backgroundColor: Theme.of(context).colorScheme.error,
      ),
    );
  }

  // --- Email/Password Sign In Logic ---
  Future<void> _signInWithEmail() async {
    if (_formKey.currentState!.validate()) {
      setState(() {
        _loading = true;
      });
      try {
        await FirebaseAuth.instance.signInWithEmailAndPassword(
          email: _emailController.text.trim(),
          password: _passwordController.text.trim(),
        );
        // Auth state listener in AuthWrapper will handle navigation
      } on FirebaseAuthException catch (e) {
        // Handle common auth errors
        String error;
        switch (e.code) {
          case 'user-not-found':
            error = 'No user found for that email.';
            break;
          case 'wrong-password':
            error = 'Wrong password provided.';
            break;
          case 'invalid-email':
            error = 'The email address is not valid.';
            break;
          case 'invalid-credential':
            error =
                'Invalid credentials. Please check your email and password.';
            break;
          default:
            error = 'An error occurred. Please try again.';
        }
        _showError(error);
      } catch (e) {
        _showError('An unexpected error occurred: ${e.toString()}');
      } finally {
        if (mounted) {
          setState(() {
            _loading = false;
          });
        }
      }
    }
  }

  // --- Google Sign In Logic ---
  Future<void> _signInWithGoogle() async {
    setState(() {
      _loading = true;
    });
    try {
      // --- THIS IS THE WEB FIX ---
      GoogleSignIn googleSignIn;
      if (kIsWeb) {
        // If we are on the web, we must pass the Client ID.
        // This ID is generated by `flutterfire configure` and stored in firebase_options.dart
        googleSignIn = GoogleSignIn(
          // --- THIS LINE IS NOW CORRECTED (removed extra .options) ---
          clientId: DefaultFirebaseOptions.currentPlatform.clientId,
        );
      } else {
        // If on Android/iOS, the default constructor works.
        googleSignIn = GoogleSignIn();
      }
      // --- END OF WEB FIX ---

      // Trigger the Google authentication flow.
      final GoogleSignInAccount? googleUser = await googleSignIn.signIn();

      if (googleUser == null) {
        // User cancelled the sign-in
        throw Exception('Google sign in cancelled.');
      }

      // Obtain the auth details from the request.
      final GoogleSignInAuthentication googleAuth =
          await googleUser.authentication;

      // Create a new credential.
      final OAuthCredential credential = GoogleAuthProvider.credential(
        accessToken: googleAuth.accessToken,
        idToken: googleAuth.idToken,
      );

      // Once signed in, return the UserCredential
      await FirebaseAuth.instance.signInWithCredential(credential);
    } on FirebaseAuthException catch (e) {
      _showError('Firebase Auth Error: ${e.message}');
    } catch (e) {
      _showError(e.toString());
    } finally {
      if (mounted) {
        setState(() {
          _loading = false;
        });
      }
    }
  }

  @override
  void dispose() {
    _emailController.dispose();
    _passwordController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: SafeArea(
        child: Center(
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(24.0),
            child: Form(
              key: _formKey,
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                crossAxisAlignment: CrossAxisAlignment.stretch,
                children: [
                  Text(
                    'Welcome Back!',
                    style: Theme.of(context).textTheme.headlineMedium?.copyWith(
                          fontWeight: FontWeight.bold,
                        ),
                    textAlign: TextAlign.center,
                  ),
                  const SizedBox(height: 8),
                  Text(
                    'Sign in to continue',
                    style: Theme.of(context).textTheme.titleMedium,
                    textAlign: TextAlign.center,
                  ),
                  const SizedBox(height: 48),

                  // Email Field
                  TextFormField(
                    controller: _emailController,
                    decoration: const InputDecoration(labelText: 'Email'),
                    keyboardType: TextInputType.emailAddress,
                    validator: (value) {
                      if (value == null || value.isEmpty) {
                        return 'Please enter your email';
                      }
                      if (!RegExp(r'\S+@\S+\.\S+').hasMatch(value)) {
                        return 'Please enter a valid email address';
                      }
                      return null;
                    },
                  ),
                  const SizedBox(height: 16),

                  // Password Field
                  TextFormField(
                    controller: _passwordController,
                    decoration: const InputDecoration(labelText: 'Password'),
                    obscureText: true,
                    validator: (value) {
                      if (value == null || value.isEmpty) {
                        return 'Please enter your password';
                      }
                      return null;
                    },
                  ),
                  const SizedBox(height: 8),

                  // Forgot Password
                  Align(
                    alignment: Alignment.centerRight,
                    child: TextButton(
                      child: const Text('Forgot Password?'),
                      onPressed: () {
                        Navigator.push(
                          context,
                          MaterialPageRoute(
                            builder: (context) => const ForgotPasswordScreen(),
                          ),
                        );
                      },
                    ),
                  ),
                  const SizedBox(height: 24),

                  // Sign In Button
                  _loading
                      ? const Center(child: CircularProgressIndicator())
                      : ElevatedButton(
                          onPressed: _signInWithEmail,
                          child: const Text('Sign In'),
                        ),
                  const SizedBox(height: 24),

                  // OR Divider
                  Row(
                    children: [
                      Expanded(child: Divider(color: Colors.grey[400])),
                      const Padding(
                        padding: EdgeInsets.symmetric(horizontal: 16.0),
                        child: Text('OR'),
                      ),
                      Expanded(child: Divider(color: Colors.grey[400])),
                    ],
                  ),
                  const SizedBox(height: 24),

                  // Google Sign In Button
                  ElevatedButton.icon(
                    icon: Image.asset(
                      'assets/google_logo.png', // You need to add this asset
                      height: 24,
                      // Handle asset not found gracefully
                      errorBuilder: (context, error, stackTrace) =>
                          const Icon(Icons.login),
                    ),
                    label: const Text('Sign In with Google'),
                    onPressed: _signInWithGoogle,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.white,
                      foregroundColor: Colors.black,
                    ),
                  ),
                  const SizedBox(height: 16),

                  // --- NEW PHONE SIGN-IN BUTTON ---
                  // Only show this button if we are NOT on the web
                  if (!kIsWeb)
                    ElevatedButton.icon(
                      icon: const Icon(Icons.phone),
                      label: const Text('Sign In with Phone'),
                      onPressed: () {
                        Navigator.push(
                          context,
                          MaterialPageRoute(
                            builder: (context) => const PhoneSignInScreen(),
                          ),
                        );
                      },
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.green[700],
                        foregroundColor: Colors.white,
                      ),
                    ),
                  const SizedBox(height: 24),

                  // Toggle to Sign Up
                  Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Text("Don't have an account?"),
                      TextButton(
                        onPressed: widget.onToggleView,
                        child: const Text('Sign Up'),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

extension on FirebaseOptions {
  String? get clientId => null;
}

// --- SignUpScreen: Handles New User Registration ---
class SignUpScreen extends StatefulWidget {
  final VoidCallback onToggleView;
  // --- THIS LINE IS NOW CORRECTED ---
  const SignUpScreen({super.key, required this.onToggleView});

  @override
  State<SignUpScreen> createState() => _SignUpScreenState();
}

class _SignUpScreenState extends State<SignUpScreen> {
  final _formKey = GlobalKey<FormState>();
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  final _confirmPasswordController = TextEditingController();
  bool _loading = false;

  void _showError(String message) {
    final displayMessage = message.startsWith("Exception: ")
        ? message.substring("Exception: ".length)
        : message;

    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(displayMessage),
        backgroundColor: Theme.of(context).colorScheme.error,
      ),
    );
  }

  // --- Email/Password Sign Up Logic ---
  Future<void> _signUpWithEmail() async {
    if (_formKey.currentState!.validate()) {
      setState(() {
        _loading = true;
      });
      try {
        await FirebaseAuth.instance.createUserWithEmailAndPassword(
          email: _emailController.text.trim(),
          password: _passwordController.text.trim(),
        );
        // AuthWrapper will handle navigation
      } on FirebaseAuthException catch (e) {
        String error;
        switch (e.code) {
          case 'weak-password':
            error = 'The password provided is too weak.';
            break;
          case 'email-already-in-use':
            error = 'An account already exists for that email.';
            break;
          case 'invalid-email':
            error = 'The email address is not valid.';
            break;
          default:
            error = 'An error occurred. Please try again.';
        }
        _showError(error);
      } catch (e) {
        _showError('An unexpected error occurred: ${e.toString()}');
      } finally {
        if (mounted) {
          setState(() {
            _loading = false;
          });
        }
      }
    }
  }

  @override
  void dispose() {
    _emailController.dispose();
    _passwordController.dispose();
    _confirmPasswordController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: SafeArea(
        child: Center(
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(24.0),
            child: Form(
              key: _formKey,
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                crossAxisAlignment: CrossAxisAlignment.stretch,
                children: [
                  Text(
                    'Create Account',
                    style: Theme.of(context).textTheme.headlineMedium?.copyWith(
                          fontWeight: FontWeight.bold,
                        ),
                    textAlign: TextAlign.center,
                  ),
                  const SizedBox(height: 8),
                  Text(
                    'Get started by creating a new account',
                    style: Theme.of(context).textTheme.titleMedium,
                    textAlign: TextAlign.center,
                  ),
                  const SizedBox(height: 48),

                  // Email Field
                  TextFormField(
                    controller: _emailController,
                    decoration: const InputDecoration(labelText: 'Email'),
                    keyboardType: TextInputType.emailAddress,
                    validator: (value) {
                      if (value == null || value.isEmpty) {
                        return 'Please enter your email';
                      }
                      if (!RegExp(r'\S+@\S+\.\S+').hasMatch(value)) {
                        return 'Please enter a valid email address';
                      }
                      return null;
                    },
                  ),
                  const SizedBox(height: 16),

                  // Password Field
                  TextFormField(
                    controller: _passwordController,
                    decoration: const InputDecoration(labelText: 'Password'),
                    obscureText: true,
                    validator: (value) {
                      if (value == null || value.isEmpty) {
                        return 'Please enter a password';
                      }
                      if (value.length < 6) {
                        return 'Password must be at least 6 characters long';
                      }
                      return null;
                    },
                  ),
                  const SizedBox(height: 16),

                  // Confirm Password Field
                  TextFormField(
                    controller: _confirmPasswordController,
                    decoration:
                        const InputDecoration(labelText: 'Confirm Password'),
                    obscureText: true,
                    validator: (value) {
                      if (value == null || value.isEmpty) {
                        return 'Please confirm your password';
                      }
                      if (value != _passwordController.text) {
                        return 'Passwords do not match';
                      }
                      return null;
                    },
                  ),
                  const SizedBox(height: 32),

                  // Sign Up Button
                  _loading
                      ? const Center(child: CircularProgressIndicator())
                      : ElevatedButton(
                          onPressed: _signUpWithEmail,
                          child: const Text('Sign Up'),
                        ),
                  const SizedBox(height: 24),

                  // Toggle to Sign In
                  Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Text('Already have an account?'),
                      TextButton(
                        onPressed: widget.onToggleView,
                        child: const Text('Sign In'),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

// --- HomeScreen: The Protected Dashboard/Profile Page ---
class HomeScreen extends StatelessWidget {
  const HomeScreen({super.key});

  // --- Sign Out Logic ---
  Future<void> _signOut(BuildContext context) async {
    try {
      // Also sign out from Google if that was the provider
      // --- THIS IS THE WEB FIX ---
      GoogleSignIn googleSignIn;
      if (kIsWeb) {
        googleSignIn = GoogleSignIn(
          // --- THIS LINE IS NOW CORRECTED (removed extra .options) ---
          clientId: DefaultFirebaseOptions.currentPlatform.clientId,
        );
      } else {
        googleSignIn = GoogleSignIn();
      }
      // --- END OF WEB FIX ---
      await googleSignIn.signOut();

      // Sign out from Firebase
      await FirebaseAuth.instance.signOut();
      // AuthWrapper will handle navigation
    } catch (e) {
      if (!context.mounted) return;
      // --- THIS LINE IS NOW CORRECTED (removed extra 'f()') ---
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error signing out: ${e.toString()}'),
          backgroundColor: Theme.of(context).colorScheme.error,
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    // Get the current user
    final user = FirebaseAuth.instance.currentUser;

    return Scaffold(
      appBar: AppBar(
        title: const Text('Home Dashboard'),
        actions: [
          // Sign Out Button
          IconButton(
            icon: const Icon(Icons.logout),
            tooltip: 'Sign Out',
            onPressed: () => _signOut(context),
          )
        ],
      ),
      body: Center(
        child: Padding(
          padding: const EdgeInsets.all(24.0),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text(
                'Welcome!',
                style: Theme.of(context).textTheme.headlineMedium,
              ),
              const SizedBox(height: 16),
              // Display user's profile picture if available (from Google)
              if (user?.photoURL != null)
                CircleAvatar(
                  backgroundImage: NetworkImage(user!.photoURL!),
                  radius: 40,
                ),
              const SizedBox(height: 16),
              // Display user's name if available (from Google)
              if (user?.displayName != null)
                Text(
                  user!.displayName!,
                  style: Theme.of(context).textTheme.titleLarge,
                ),
              const SizedBox(height: 8),
              // Display user's email
              Text(
                user?.email ?? 'No email found',
                style: Theme.of(context).textTheme.titleMedium,
              ),
              // --- NEWLY ADDED ---
              // Display user's phone number
              if (user?.phoneNumber != null && user!.phoneNumber!.isNotEmpty)
                Padding(
                  padding: const EdgeInsets.only(top: 8.0),
                  child: Text(
                    user.phoneNumber!,
                    style: Theme.of(context).textTheme.titleMedium,
                  ),
                ),
            ],
          ),
        ),
      ),
    );
  }
}

// --- REMOVED BROKEN EXTENSION ---
// The incorrect extension on FirebaseOptions was removed from here.

// --- ForgotPasswordScreen: Handles Password Reset ---
class ForgotPasswordScreen extends StatefulWidget {
  const ForgotPasswordScreen({super.key});

  @override
  State<ForgotPasswordScreen> createState() => _ForgotPasswordScreenState();
}

class _ForgotPasswordScreenState extends State<ForgotPasswordScreen> {
  final _emailController = TextEditingController();
  final _formKey = GlobalKey<FormState>();
  bool _loading = false;

  void _showFeedback(String message, {bool isError = false}) {
    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor:
            isError ? Theme.of(context).colorScheme.error : Colors.green,
      ),
    );
  }

  Future<void> _sendResetEmail() async {
    if (_formKey.currentState!.validate()) {
      setState(() => _loading = true);
      try {
        await FirebaseAuth.instance.sendPasswordResetEmail(
          email: _emailController.text.trim(),
        );
        _showFeedback('Password reset email sent. Check your inbox.');
        if (mounted) {
          Navigator.pop(context); // Go back to login screen
        }
      } on FirebaseAuthException catch (e) {
        _showFeedback(e.message ?? 'An error occurred', isError: true);
      } catch (e) {
        _showFeedback(e.toString(), isError: true);
      } finally {
        if (mounted) {
          setState(() => _loading = false);
        }
      }
    }
  }

  @override
  void dispose() {
    _emailController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Reset Password'),
      ),
      body: Padding(
        padding: const EdgeInsets.all(24.0),
        child: Form(
          key: _formKey,
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              Text(
                'Forgot Your Password?',
                style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                      fontWeight: FontWeight.bold,
                    ),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 16),
              const Text(
                'Enter your email address and we will send you a link to reset your password.',
                style: TextStyle(fontSize: 16),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 32),
              TextFormField(
                controller: _emailController,
                decoration: const InputDecoration(labelText: 'Email'),
                keyboardType: TextInputType.emailAddress,
                validator: (value) {
                  if (value == null || value.isEmpty) {
                    return 'Please enter your email';
                  }
                  if (!RegExp(r'\S+@\S+\.\S+').hasMatch(value)) {
                    return 'Please enter a valid email address';
                  }
                  return null;
                },
              ),
              const SizedBox(height: 32),
              _loading
                  ? const Center(child: CircularProgressIndicator())
                  : ElevatedButton(
                      onPressed: _sendResetEmail,
                      child: const Text('Send Reset Email'),
                    ),
            ],
          ),
        ),
      ),
    );
  }
}

// --- NEW WIDGET: PhoneSignInScreen ---
class PhoneSignInScreen extends StatefulWidget {
  const PhoneSignInScreen({super.key});

  @override
  State<PhoneSignInScreen> createState() => _PhoneSignInScreenState();
}

class _PhoneSignInScreenState extends State<PhoneSignInScreen> {
  final _phoneController = TextEditingController();
  final _otpController = TextEditingController();
  final _formKey = GlobalKey<FormState>();
  final _otpFormKey = GlobalKey<FormState>();

  bool _loading = false;
  bool _isOtpSent = false;
  String _verificationId = '';

  void _showError(String message) {
    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Theme.of(context).colorScheme.error,
      ),
    );
  }

  // Step 1: Send the OTP
  Future<void> _sendOtp() async {
    if (!_formKey.currentState!.validate()) return;
    setState(() => _loading = true);

    try {
      await FirebaseAuth.instance.verifyPhoneNumber(
        phoneNumber: _phoneController.text.trim(),
        // (1) Auto-verification (Android only)
        verificationCompleted: (PhoneAuthCredential credential) async {
          setState(() => _loading = true);
          await FirebaseAuth.instance.signInWithCredential(credential);
          if (mounted) Navigator.pop(context); // Go back to AuthWrapper
        },
        // (2) Verification failed
        verificationFailed: (FirebaseAuthException e) {
          String error;
          switch (e.code) {
            case 'invalid-phone-number':
              error = 'The phone number is not valid.';
              break;
            case 'too-many-requests':
              error = 'Too many requests. Please try again later.';
              break;
            default:
              error = 'An error occurred: ${e.message}';
          }
          _showError(error);
          setState(() => _loading = false);
        },
        // (3) OTP code sent
        codeSent: (String verificationId, int? resendToken) {
          setState(() {
            _verificationId = verificationId;
            _isOtpSent = true;
            _loading = false;
          });
        },
        // (4) Timeout
        codeAutoRetrievalTimeout: (String verificationId) {
          _verificationId = verificationId;
          // You could auto-resend here if needed
        },
      );
    } catch (e) {
      _showError(e.toString());
      setState(() => _loading = false);
    }
  }

  // Step 2: Verify the OTP
  Future<void> _verifyOtp() async {
    if (!_otpFormKey.currentState!.validate()) return;
    setState(() => _loading = true);

    try {
      // Create a credential with the verification ID and the OTP code
      final credential = PhoneAuthProvider.credential(
        verificationId: _verificationId,
        smsCode: _otpController.text.trim(),
      );

      // Sign the user in
      await FirebaseAuth.instance.signInWithCredential(credential);

      // Navigate home (or back to wrapper)
      if (mounted) Navigator.pop(context);
    } on FirebaseAuthException catch (e) {
      String error;
      switch (e.code) {
        case 'invalid-verification-code':
          error = 'The OTP code is invalid.';
          break;
        case 'session-expired':
          error = 'The session has expired. Please send the OTP again.';
          break;
        default:
          error = 'An error occurred: ${e.message}';
      }
      _showError(error);
    } catch (e) {
      _showError(e.toString());
    } finally {
      if (mounted) setState(() => _loading = false);
    }
  }

  @override
  void dispose() {
    _phoneController.dispose();
    _otpController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(_isOtpSent ? 'Enter OTP' : 'Sign In with Phone'),
      ),
      body: Padding(
        padding: const EdgeInsets.all(24.0),
        child: _isOtpSent ? _buildOtpForm() : _buildPhoneForm(),
      ),
    );
  }

  // --- Form for entering the Phone Number ---
  Widget _buildPhoneForm() {
    return Form(
      key: _formKey,
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        crossAxisAlignment: CrossAxisAlignment.stretch,
        children: [
          Text(
            'Enter Your Phone Number',
            style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                  fontWeight: FontWeight.bold,
                ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 16),
          const Text(
            'We will send you a 6-digit verification code.',
            style: TextStyle(fontSize: 16),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 32),
          TextFormField(
            controller: _phoneController,
            decoration: const InputDecoration(
              labelText: 'Phone Number',
              hintText: '+91 999 999 9999',
            ),
            keyboardType: TextInputType.phone,
            validator: (value) {
              if (value == null || value.isEmpty) {
                return 'Please enter your phone number';
              }
              if (!RegExp(r'^\+[1-9]\d{1,14}$').hasMatch(value)) {
                return 'Please enter a valid number with country code (e.g. +91)';
              }
              return null;
            },
          ),
          const SizedBox(height: 32),
          _loading
              ? const Center(child: CircularProgressIndicator())
              : ElevatedButton(
                  onPressed: _sendOtp,
                  child: const Text('Send OTP'),
                ),
        ],
      ),
    );
  }

  // --- Form for entering the OTP ---
  Widget _buildOtpForm() {
    return Form(
      key: _otpFormKey,
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        crossAxisAlignment: CrossAxisAlignment.stretch,
        children: [
          Text(
            'Verify Your Phone',
            style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                  fontWeight: FontWeight.bold,
                ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 16),
          Text(
            'Enter the 6-digit code sent to ${_phoneController.text}',
            style: const TextStyle(fontSize: 16),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 32),
          TextFormField(
            controller: _otpController,
            decoration: const InputDecoration(
              labelText: '6-Digit OTP',
            ),
            keyboardType: TextInputType.number,
            inputFormatters: [FilteringTextInputFormatter.digitsOnly],
            maxLength: 6,
            validator: (value) {
              if (value == null || value.isEmpty) {
                return 'Please enter the OTP';
              }
              if (value.length != 6) {
                return 'The OTP must be 6 digits';
              }
              return null;
            },
          ),
          const SizedBox(height: 32),
          _loading
              ? const Center(child: CircularProgressIndicator())
              : ElevatedButton(
                  onPressed: _verifyOtp,
                  child: const Text('Verify & Sign In'),
                ),
          const SizedBox(height: 16),
          TextButton(
            onPressed: () => setState(() {
              _isOtpSent = false;
              _loading = false;
            }),
            child: const Text('Use a different number?'),
          )
        ],
      ),
    );
  }
}

